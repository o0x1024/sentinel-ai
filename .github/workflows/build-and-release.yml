name: Build and Release Sentinel AI

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build for ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: 'darwin-aarch64'
            rust_target: 'aarch64-apple-darwin'
          - os: windows-latest
            platform: 'windows-x86_64'
            rust_target: 'x86_64-pc-windows-msvc'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache Rust Dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Install OpenSSL for macOS
        if: runner.os == 'macOS'
        run: |
          brew install openssl@3
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=$(brew --prefix openssl@3)/lib" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=$(brew --prefix openssl@3)/include" >> $GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV

      - name: Install OpenSSL for Windows
        if: runner.os == 'Windows'
        run: |
          vcpkg install openssl:x64-windows-static
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          echo "OPENSSL_DIR=C:\vcpkg\installed\x64-windows-static" >> $env:GITHUB_ENV
          echo "OPENSSL_LIB_DIR=C:\vcpkg\installed\x64-windows-static\lib" >> $env:GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=C:\vcpkg\installed\x64-windows-static\include" >> $env:GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $env:GITHUB_ENV

      - name: Install Frontend Dependencies
        run: yarn install

      - name: Import Apple Certificate
        if: runner.os == 'macOS'
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}

      - name: Build Tauri App
        shell: bash
        run: yarn tauri build --target ${{ matrix.rust_target }}
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          OPENSSL_DIR: ${{ env.OPENSSL_DIR }}
          OPENSSL_LIB_DIR: ${{ env.OPENSSL_LIB_DIR }}
          OPENSSL_INCLUDE_DIR: ${{ env.OPENSSL_INCLUDE_DIR }}
          OPENSSL_STATIC: ${{ env.OPENSSL_STATIC }}
          OPENSSL_NO_VENDOR: ${{ env.OPENSSL_NO_VENDOR }}
          VCPKG_ROOT: ${{ env.VCPKG_ROOT }}
          CFLAGS: ${{ env.CFLAGS }}
          LDFLAGS: ${{ env.LDFLAGS }}
          CPPFLAGS: ${{ env.CPPFLAGS }}
          PKG_CONFIG_PATH: ${{ env.PKG_CONFIG_PATH }}
          RUSTFLAGS: ${{ env.RUSTFLAGS }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-build-${{ matrix.platform }}
          path: |
            src-tauri/target/${{ matrix.rust_target }}/release/bundle/

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: yarn install

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: src-tauri/target/

      - name: Get Version from Tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Generate Update Manifest
        run: |
          chmod +x scripts/generate-update-manifest.cjs
          node scripts/generate-update-manifest.cjs
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          RELEASE_NOTES: "See the release notes for details."
          npm_package_version: ${{ steps.get_version.outputs.VERSION }}

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: 'Sentinel AI v${{ steps.get_version.outputs.VERSION }}'
          body: |
            ## Sentinel AI v${{ steps.get_version.outputs.VERSION }}
            
            ### ðŸš€ Features
            - AI-driven vulnerability discovery
            - MCP tools dynamic integration
            - Performance optimization and monitoring
            
            ### ðŸ“¦ Platform Support
            - Windows x64 (.exe installer)
            - macOS ARM64 (.dmg)
            
            See [CHANGELOG.md](CHANGELOG.md) for full changelog.
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x

          TARGET_DIR="src-tauri/target"
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          UPLOAD_DIR=$(mktemp -d)
          echo "UPLOAD_DIR=$UPLOAD_DIR" >> $GITHUB_ENV

          # macOS aarch64 artifacts
          if [ -d "$TARGET_DIR/tauri-build-darwin-aarch64" ]; then
            find "$TARGET_DIR/tauri-build-darwin-aarch64/macos" -name "*.app.tar.gz" -exec mv {} "$UPLOAD_DIR/sentinel-ai-${VERSION}-aarch64.app.tar.gz" \;
            find "$TARGET_DIR/tauri-build-darwin-aarch64/macos" -name "*.app.tar.gz.sig" -exec mv {} "$UPLOAD_DIR/sentinel-ai-${VERSION}-aarch64.app.tar.gz.sig" \;
            find "$TARGET_DIR/tauri-build-darwin-aarch64/dmg" -name "*.dmg" -exec mv {} "$UPLOAD_DIR/sentinel-ai-${VERSION}-aarch64.dmg" \;
            find "$TARGET_DIR/tauri-build-darwin-aarch64/dmg" -name "*.dmg.sig" -exec mv {} "$UPLOAD_DIR/sentinel-ai-${VERSION}-aarch64.dmg.sig" \;
            if [ ! -f "$UPLOAD_DIR/sentinel-ai-${VERSION}-aarch64.dmg" ]; then
              find "$TARGET_DIR/tauri-build-darwin-aarch64" -name "*.dmg" -exec cp {} "$UPLOAD_DIR/sentinel-ai-${VERSION}-aarch64.dmg" \;
              find "$TARGET_DIR/tauri-build-darwin-aarch64" -name "*.dmg.sig" -exec cp {} "$UPLOAD_DIR/sentinel-ai-${VERSION}-aarch64.dmg.sig" \;
            fi
          fi

          # Windows artifacts (NSIS)
          if [ -d "$TARGET_DIR/tauri-build-windows-x86_64" ]; then
            find "$TARGET_DIR/tauri-build-windows-x86_64/nsis" -name "*_x64-setup.exe" -exec mv {} "$UPLOAD_DIR/sentinel-ai-${VERSION}-x64-setup.exe" \;
            find "$TARGET_DIR/tauri-build-windows-x86_64/nsis" -name "*_x64-setup.exe.sig" -exec mv {} "$UPLOAD_DIR/sentinel-ai-${VERSION}-x64-setup.exe.sig" \;
            find "$TARGET_DIR/tauri-build-windows-x86_64/nsis" -name "*_x64-setup.nsis.zip" -exec mv {} "$UPLOAD_DIR/sentinel-ai-${VERSION}-x64-setup.nsis.zip" \;
            find "$TARGET_DIR/tauri-build-windows-x86_64/nsis" -name "*_x64-setup.nsis.zip.sig" -exec mv {} "$UPLOAD_DIR/sentinel-ai-${VERSION}-x64-setup.nsis.zip.sig" \;
          fi

          echo "Files in upload directory:"
          ls -la "$UPLOAD_DIR"
          echo "Signature files:"
          find "$UPLOAD_DIR" -name "*.sig" -ls

          # Regenerate manifest with actual signature files
          echo "Regenerating update manifest..."
          UPLOAD_DIR="$UPLOAD_DIR" node scripts/generate-update-manifest.cjs

          # Copy manifest files
          if [ -d "dist/update-manifests" ]; then
            if [ -f "dist/update-manifests/latest.json" ]; then
              cp "dist/update-manifests/latest.json" "$UPLOAD_DIR/latest.json"
            fi
            find dist/update-manifests -name "*.json" -exec cp {} "$UPLOAD_DIR/" \;
          fi

          ls -l "$UPLOAD_DIR"

          # Upload all files
          if [ -n "$(ls -A "$UPLOAD_DIR")" ]; then
            gh release upload ${{ github.ref_name }} "$UPLOAD_DIR"/*
          else
            echo "No files to upload."
          fi
