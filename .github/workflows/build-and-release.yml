name: Build and Release Sentinel AI

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build for ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            platform: 'darwin-aarch64'
            rust_target: 'aarch64-apple-darwin'
            arch_label: 'aarch64'
          - os: macos-13
            platform: 'darwin-x86_64'
            rust_target: 'x86_64-apple-darwin'
            arch_label: 'x86_64'
          - os: windows-latest
            platform: 'windows-x86_64'
            rust_target: 'x86_64-pc-windows-msvc'
            arch_label: 'x64'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache Rust Dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Install Dependencies for macOS
        if: runner.os == 'macOS'
        run: |
          brew install openssl@3 protobuf
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=$(brew --prefix openssl@3)/lib" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=$(brew --prefix openssl@3)/include" >> $GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV

      - name: Ensure vcpkg is available
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (-Not (Test-Path 'C:\vcpkg')) {
            git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
            & C:\vcpkg\bootstrap-vcpkg.bat
          }
          Add-Content -Path $env:GITHUB_ENV -Value 'VCPKG_ROOT=C:\vcpkg'

      - name: Install OpenSSL for Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          vcpkg install openssl:x64-windows-static
          Add-Content -Path $env:GITHUB_ENV -Value 'OPENSSL_DIR=C:\vcpkg\installed\x64-windows-static'
          Add-Content -Path $env:GITHUB_ENV -Value 'OPENSSL_LIB_DIR=C:\vcpkg\installed\x64-windows-static\lib'
          Add-Content -Path $env:GITHUB_ENV -Value 'OPENSSL_INCLUDE_DIR=C:\vcpkg\installed\x64-windows-static\include'
          Add-Content -Path $env:GITHUB_ENV -Value 'OPENSSL_STATIC=1'

      - name: Install protoc for Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $protocVersion = '28.2'
          $protocZip = "protoc-$protocVersion-win64.zip"
          Invoke-WebRequest -Uri "https://github.com/protocolbuffers/protobuf/releases/download/v$protocVersion/$protocZip" -OutFile $protocZip -UseBasicParsing
          Expand-Archive -Path $protocZip -DestinationPath C:\protoc -Force
          $protocBin = 'C:\protoc\bin'
          $protocInclude = 'C:\protoc\include'
          Add-Content -Path $env:GITHUB_PATH -Value $protocBin
          Add-Content -Path $env:GITHUB_ENV -Value "PROTOC=$protocBin\protoc.exe"
          Add-Content -Path $env:GITHUB_ENV -Value "PROTOC_INCLUDE=$protocInclude"

      - name: Install Npcap SDK for Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri 'https://npcap.com/dist/npcap-sdk-1.16.zip' -OutFile npcap-sdk.zip -UseBasicParsing
          Expand-Archive -Path npcap-sdk.zip -DestinationPath C:\ -Force
          $libPath = 'C:\npcap-sdk-1.16\Lib\x64'
          $existingLib = [Environment]::GetEnvironmentVariable('LIB', 'Process')
          Add-Content -Path $env:GITHUB_ENV -Value "LIB=$libPath;$existingLib"

      - name: Install Frontend Dependencies
        run: yarn install

      - name: Import Apple Certificate
        if: runner.os == 'macOS' && env.MACOS_CERTIFICATE != ''
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}

      - name: Build Tauri App
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "macOS" ] && [ -z "$MACOS_CERT_CHECK" ]; then
            echo "Building without code signing..."
            export APPLE_SIGNING_IDENTITY="-"
          fi
          yarn tauri build --target ${{ matrix.rust_target }}
        env:
          MACOS_CERT_CHECK: ${{ secrets.MACOS_CERTIFICATE }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          OPENSSL_DIR: ${{ env.OPENSSL_DIR }}
          OPENSSL_LIB_DIR: ${{ env.OPENSSL_LIB_DIR }}
          OPENSSL_INCLUDE_DIR: ${{ env.OPENSSL_INCLUDE_DIR }}
          OPENSSL_STATIC: ${{ env.OPENSSL_STATIC }}
          OPENSSL_NO_VENDOR: ${{ env.OPENSSL_NO_VENDOR }}
          VCPKG_ROOT: ${{ env.VCPKG_ROOT }}
          CFLAGS: ${{ env.CFLAGS }}
          LDFLAGS: ${{ env.LDFLAGS }}
          CPPFLAGS: ${{ env.CPPFLAGS }}
          PKG_CONFIG_PATH: ${{ env.PKG_CONFIG_PATH }}
          RUSTFLAGS: ${{ env.RUSTFLAGS }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-build-${{ matrix.platform }}
          path: |
            src-tauri/target/${{ matrix.rust_target }}/release/bundle/

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: yarn install

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: src-tauri/target/

      - name: Get Version from Tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Generate Update Manifest
        run: |
          chmod +x scripts/generate-update-manifest.cjs
          node scripts/generate-update-manifest.cjs
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          RELEASE_NOTES: "See the release notes for details."
          npm_package_version: ${{ steps.get_version.outputs.VERSION }}

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: 'Sentinel AI v${{ steps.get_version.outputs.VERSION }}'
          body: |
            ## Sentinel AI v${{ steps.get_version.outputs.VERSION }}
            
            ### ðŸš€ Features
            - AI-driven vulnerability discovery
            - MCP tools dynamic integration
            - Performance optimization and monitoring
            
            ### ðŸ“¦ Platform Support
            - Windows x64 (.exe installer)
            - macOS ARM64 (.dmg)
            
            See [CHANGELOG.md](CHANGELOG.md) for full changelog.
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail

          TARGET_DIR="src-tauri/target"
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          UPLOAD_DIR=$(mktemp -d)
          echo "UPLOAD_DIR=$UPLOAD_DIR" >> $GITHUB_ENV

          collect_macos() {
            local platform_dir="$1"
            local arch="$2"

            local macos_dir="$platform_dir/macos"
            if [ -d "$macos_dir" ]; then
              local app_pkg
              app_pkg=$(find "$macos_dir" -type f -name "*.app.tar.gz" -print -quit || true)
              if [ -n "$app_pkg" ]; then
                cp "$app_pkg" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}.app.tar.gz"
              fi

              local app_sig
              app_sig=$(find "$macos_dir" -type f -name "*.app.tar.gz.sig" -print -quit || true)
              if [ -n "$app_sig" ]; then
                cp "$app_sig" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}.app.tar.gz.sig"
              fi
            else
              local fallback_app
              fallback_app=$(find "$platform_dir" -maxdepth 2 -type f -name "*.app.tar.gz" -print -quit || true)
              if [ -n "$fallback_app" ]; then
                cp "$fallback_app" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}.app.tar.gz"
              fi

              local fallback_app_sig
              fallback_app_sig=$(find "$platform_dir" -maxdepth 2 -type f -name "*.app.tar.gz.sig" -print -quit || true)
              if [ -n "$fallback_app_sig" ]; then
                cp "$fallback_app_sig" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}.app.tar.gz.sig"
              fi
            fi

            local dmg_dir="$platform_dir/dmg"
            if [ -d "$dmg_dir" ]; then
              local dmg_pkg
              dmg_pkg=$(find "$dmg_dir" -type f -name "*.dmg" -print -quit || true)
              if [ -n "$dmg_pkg" ]; then
                cp "$dmg_pkg" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}.dmg"
              fi

              local dmg_sig
              dmg_sig=$(find "$dmg_dir" -type f -name "*.dmg.sig" -print -quit || true)
              if [ -n "$dmg_sig" ]; then
                cp "$dmg_sig" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}.dmg.sig"
              fi
            else
              local fallback_dmg
              fallback_dmg=$(find "$platform_dir" -maxdepth 2 -type f -name "*.dmg" -print -quit || true)
              if [ -n "$fallback_dmg" ]; then
                cp "$fallback_dmg" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}.dmg"
              fi

              local fallback_dmg_sig
              fallback_dmg_sig=$(find "$platform_dir" -maxdepth 2 -type f -name "*.dmg.sig" -print -quit || true)
              if [ -n "$fallback_dmg_sig" ]; then
                cp "$fallback_dmg_sig" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}.dmg.sig"
              fi
            fi
          }

          collect_windows() {
            local platform_dir="$1"
            local arch="$2"
            local nsis_dir="$platform_dir/nsis"

            if [ -d "$nsis_dir" ]; then
              local installer
              installer=$(find "$nsis_dir" -type f -name "*_x64-setup.exe" -print -quit || true)
              if [ -n "$installer" ]; then
                cp "$installer" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}-setup.exe"
              fi

              local installer_sig
              installer_sig=$(find "$nsis_dir" -type f -name "*_x64-setup.exe.sig" -print -quit || true)
              if [ -n "$installer_sig" ]; then
                cp "$installer_sig" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}-setup.exe.sig"
              fi

              local nsis_pkg
              nsis_pkg=$(find "$nsis_dir" -type f -name "*_x64-setup.nsis.zip" -print -quit || true)
              if [ -n "$nsis_pkg" ]; then
                cp "$nsis_pkg" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}-setup.nsis.zip"
              fi

              local nsis_sig
              nsis_sig=$(find "$nsis_dir" -type f -name "*_x64-setup.nsis.zip.sig" -print -quit || true)
              if [ -n "$nsis_sig" ]; then
                cp "$nsis_sig" "$UPLOAD_DIR/sentinel-ai-${VERSION}-${arch}-setup.nsis.zip.sig"
              fi
            fi
          }

          for PLATFORM_PATH in "$TARGET_DIR"/tauri-build-*; do
            [ -d "$PLATFORM_PATH" ] || continue
            PLATFORM_NAME=$(basename "$PLATFORM_PATH")

            case "$PLATFORM_NAME" in
              tauri-build-darwin-aarch64)
                collect_macos "$PLATFORM_PATH" "aarch64"
                ;;
              tauri-build-darwin-x86_64)
                collect_macos "$PLATFORM_PATH" "x86_64"
                ;;
              tauri-build-windows-x86_64)
                collect_windows "$PLATFORM_PATH" "x64"
                ;;
              *)
                echo "Skipping unsupported platform directory: $PLATFORM_NAME"
                ;;
            esac
          done

          echo "Files in upload directory:"
          ls -la "$UPLOAD_DIR"
          echo "Signature files:"
          find "$UPLOAD_DIR" -name "*.sig" -ls

          # Regenerate manifest with actual signature files
          echo "Regenerating update manifest..."
          UPLOAD_DIR="$UPLOAD_DIR" node scripts/generate-update-manifest.cjs

          # Copy manifest files
          if [ -d "dist/update-manifests" ]; then
            if [ -f "dist/update-manifests/latest.json" ]; then
              cp "dist/update-manifests/latest.json" "$UPLOAD_DIR/latest.json"
            fi
            find dist/update-manifests -name "*.json" -exec cp {} "$UPLOAD_DIR/" \;
          fi

          ls -l "$UPLOAD_DIR"

          # Upload all files
          if [ -n "$(ls -A "$UPLOAD_DIR")" ]; then
            gh release upload ${{ github.ref_name }} "$UPLOAD_DIR"/*
          else
            echo "No files to upload."
          fi
