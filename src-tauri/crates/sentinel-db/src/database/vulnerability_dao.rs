use anyhow::Result;
use sentinel_core::models::database::Vulnerability;
use sqlx::sqlite::SqlitePool;

pub async fn create_vulnerability(pool: &SqlitePool, vuln: &Vulnerability) -> Result<()> {
    sqlx::query(
        r#"
        INSERT INTO vulnerabilities (
            id, project_id, asset_id, scan_task_id, title, description,
            vulnerability_type, severity, cvss_score, cvss_vector, cwe_id,
            owasp_category, proof_of_concept, impact, remediation, references,
            status, verification_status, tags, attachments, notes
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        "#,
    )
    .bind(&vuln.id)
    .bind(&vuln.project_id)
    .bind(&vuln.asset_id)
    .bind(&vuln.scan_task_id)
    .bind(&vuln.title)
    .bind(&vuln.description)
    .bind(&vuln.vulnerability_type)
    .bind(&vuln.severity)
    .bind(vuln.cvss_score)
    .bind(&vuln.cvss_vector)
    .bind(&vuln.cwe_id)
    .bind(&vuln.owasp_category)
    .bind(&vuln.proof_of_concept)
    .bind(&vuln.impact)
    .bind(&vuln.remediation)
    .bind(&vuln.references)
    .bind(&vuln.status)
    .bind(&vuln.verification_status)
    .bind(&vuln.tags)
    .bind(&vuln.attachments)
    .bind(&vuln.notes)
    .execute(pool)
    .await?;
    Ok(())
}

pub async fn get_vulnerabilities(pool: &SqlitePool, project_id: Option<&str>) -> Result<Vec<Vulnerability>> {
    let rows = if let Some(project_id) = project_id {
        sqlx::query_as::<_, Vulnerability>(
            "SELECT * FROM vulnerabilities WHERE project_id = ? ORDER BY created_at DESC",
        )
        .bind(project_id)
        .fetch_all(pool)
        .await?
    } else {
        sqlx::query_as::<_, Vulnerability>(
            "SELECT * FROM vulnerabilities ORDER BY created_at DESC",
        )
        .fetch_all(pool)
        .await?
    };
    Ok(rows)
}

pub async fn get_vulnerability(pool: &SqlitePool, id: &str) -> Result<Option<Vulnerability>> {
    let row = sqlx::query_as::<_, Vulnerability>(
        "SELECT * FROM vulnerabilities WHERE id = ?",
    )
    .bind(id)
    .fetch_optional(pool)
    .await?;
    Ok(row)
}

pub async fn update_vulnerability_status(pool: &SqlitePool, id: &str, status: &str) -> Result<()> {
    sqlx::query(
        "UPDATE vulnerabilities SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?",
    )
    .bind(status)
    .bind(id)
    .execute(pool)
    .await?;
    Ok(())
}


