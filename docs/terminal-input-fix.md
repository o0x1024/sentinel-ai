# Terminal Input Fix - ç»ˆç«¯è¾“å…¥ä¿®å¤

## é—®é¢˜æè¿°

ç»ˆç«¯é¢æ¿æ˜¾ç¤ºè¿æ¥æˆåŠŸï¼Œä½†æ— æ³•è¾“å…¥å†…å®¹ã€‚ç”¨æˆ·åœ¨ç»ˆç«¯åŒºåŸŸè¾“å…¥æ—¶æ²¡æœ‰ä»»ä½•å“åº”ã€‚

## æ ¹æœ¬åŸå› 

WebSocket æœåŠ¡å™¨ç«¯åªå¤„ç† **Binary** æ¶ˆæ¯ï¼Œä½†å¿½ç•¥äº† **Text** æ¶ˆæ¯ï¼š

```rust
// ä¹‹å‰çš„ä»£ç 
match msg {
    Ok(Message::Binary(data)) => {
        // å¤„ç†äºŒè¿›åˆ¶æ¶ˆæ¯
        manager.write_to_session(&session_id_clone, data).await?;
    }
    Ok(Message::Text(text)) => {
        // âŒ æ²¡æœ‰å¤„ç†æ–‡æœ¬æ¶ˆæ¯ï¼Œåªæ˜¯å¿½ç•¥äº†
        // å¯¼è‡´ç”¨æˆ·è¾“å…¥æ— å“åº”
    }
    // ...
}
```

### xterm.js å‘é€çš„æ•°æ®æ ¼å¼

xterm.js çš„ `onData` äº‹ä»¶è¿”å›çš„æ˜¯ **å­—ç¬¦ä¸²**ï¼š

```typescript
terminal.value?.onData((data) => {
  if (ws.value?.readyState === WebSocket.OPEN) {
    ws.value.send(data)  // å‘é€çš„æ˜¯æ–‡æœ¬å­—ç¬¦ä¸²
  }
})
```

WebSocket çš„ `send(string)` æ–¹æ³•ä¼šå‘é€ **Text å¸§**ï¼Œè€Œä¸æ˜¯ Binary å¸§ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹ `server.rs`

åœ¨ WebSocket æ¶ˆæ¯å¤„ç†ä¸­æ·»åŠ  Text æ¶ˆæ¯çš„å¤„ç†ï¼š

```rust
// Handle input from WebSocket
let manager = self.manager.clone();
let session_id_clone = session_id.clone();
while let Some(msg) = ws_receiver.next().await {
    match msg {
        Ok(Message::Binary(data)) => {
            if let Err(e) = manager.write_to_session(&session_id_clone, data).await {
                warn!("Failed to write to session: {}", e);
                break;
            }
        }
        Ok(Message::Text(text)) => {
            // âœ… æ–°å¢ï¼šå°†æ–‡æœ¬è½¬æ¢ä¸ºå­—èŠ‚å¹¶å†™å…¥ä¼šè¯
            let data = text.into_bytes();
            if let Err(e) = manager.write_to_session(&session_id_clone, data).await {
                warn!("Failed to write to session: {}", e);
                break;
            }
        }
        Ok(Message::Close(_)) => {
            info!("Client closed connection for session: {}", session_id_clone);
            break;
        }
        // ... å…¶ä»–æ¶ˆæ¯ç±»å‹
    }
}
```

## æ•°æ®æµåˆ†æ

### å®Œæ•´çš„è¾“å…¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”¨æˆ·åœ¨ç»ˆç«¯è¾“å…¥                                           â”‚
â”‚     é”®ç›˜è¾“å…¥ â†’ xterm.js                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. xterm.js onData äº‹ä»¶                                     â”‚
â”‚     terminal.onData((data: string) => { ... })               â”‚
â”‚     data = "w" (ç”¨æˆ·æŒ‰ä¸‹ 'w' é”®)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. WebSocket å‘é€                                           â”‚
â”‚     ws.send(data)  // å‘é€æ–‡æœ¬å­—ç¬¦ä¸²                         â”‚
â”‚     â†’ WebSocket Text Frame                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æœåŠ¡å™¨æ¥æ”¶ (server.rs)                                   â”‚
â”‚     Message::Text(text) => {                                 â”‚
â”‚         let data = text.into_bytes();  // "w" â†’ [119]        â”‚
â”‚         manager.write_to_session(data).await;                â”‚
â”‚     }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. å†™å…¥ä¼šè¯ (manager.rs)                                    â”‚
â”‚     session.write(data).await                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. å†™å…¥ stdin (session.rs)                                  â”‚
â”‚     stdin_tx.send(data).await                                â”‚
â”‚     â†’ stdin writer task                                      â”‚
â”‚     â†’ stdin.write_all(&data).await                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. Docker å®¹å™¨ä¸­çš„ bash                                     â”‚
â”‚     æ¥æ”¶å­—ç¬¦ 'w'                                             â”‚
â”‚     å›æ˜¾åˆ° stdout                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. è¯»å– stdout (session.rs)                                 â”‚
â”‚     stdout reader task                                       â”‚
â”‚     â†’ output_tx.send(data).await                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. å‘é€åˆ° WebSocket (server.rs)                             â”‚
â”‚     ws_sender.send(Message::Binary(data)).await              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  10. å‰ç«¯æ¥æ”¶å¹¶æ˜¾ç¤º (InteractiveTerminal.vue)               â”‚
â”‚      ws.onmessage = (event) => {                             â”‚
â”‚          terminal.write(event.data)                          â”‚
â”‚      }                                                        â”‚
â”‚      â†’ ç»ˆç«¯æ˜¾ç¤º 'w'                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸ºä»€ä¹ˆä¹‹å‰ä¸å·¥ä½œ

### é—®é¢˜ç‚¹

åœ¨æ­¥éª¤ 4ï¼ŒæœåŠ¡å™¨æ¥æ”¶åˆ° `Message::Text`ï¼Œä½†ä¹‹å‰çš„ä»£ç æ²¡æœ‰å¤„ç†å®ƒï¼š

```rust
// âŒ ä¹‹å‰çš„ä»£ç 
Ok(Message::Text(text)) => {
    // ç©ºçš„ï¼Œä»€ä¹ˆéƒ½ä¸åš
    // ç”¨æˆ·è¾“å…¥è¢«ä¸¢å¼ƒ
}
```

ç»“æœï¼š
- ç”¨æˆ·è¾“å…¥å‘é€åˆ°æœåŠ¡å™¨ âœ…
- æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ âœ…
- æœåŠ¡å™¨å¿½ç•¥æ¶ˆæ¯ âŒ
- bash æ²¡æœ‰æ”¶åˆ°è¾“å…¥ âŒ
- ç»ˆç«¯æ²¡æœ‰å“åº” âŒ

## æµ‹è¯•éªŒè¯

### 1. ç¼–è¯‘å¹¶é‡å¯åº”ç”¨

```bash
cd src-tauri
cargo build --release
```

### 2. æµ‹è¯•è¾“å…¥

åœ¨ç»ˆç«¯ä¸­è¾“å…¥ï¼š
```bash
whoami
```

åº”è¯¥çœ‹åˆ°ï¼š
```
root
```

### 3. æµ‹è¯•äº¤äº’å¼å‘½ä»¤

```bash
python3
>>> print("Hello")
Hello
>>> exit()
```

### 4. æµ‹è¯•ç‰¹æ®Šå­—ç¬¦

- **Ctrl+C**: ä¸­æ–­å‘½ä»¤
- **Ctrl+D**: EOF
- **æ–¹å‘é”®**: å‘½ä»¤å†å²
- **Tab**: è‡ªåŠ¨è¡¥å…¨

## å…¶ä»–å¯èƒ½çš„é—®é¢˜

### 1. è¾“å‡ºä¸æ˜¾ç¤º

å¦‚æœè¾“å…¥æœ‰å“åº”ä½†çœ‹ä¸åˆ°è¾“å‡ºï¼Œæ£€æŸ¥ï¼š

```typescript
// InteractiveTerminal.vue
ws.value.onmessage = (event) => {
  if (typeof event.data === 'string') {
    terminal.value?.write(event.data)  // âœ… æ˜¾ç¤ºæ–‡æœ¬
  } else if (event.data instanceof Blob) {
    event.data.arrayBuffer().then((buffer) => {
      const text = new TextDecoder().decode(buffer)
      terminal.value?.write(text)  // âœ… æ˜¾ç¤ºäºŒè¿›åˆ¶
    })
  }
}
```

### 2. è¾“å…¥å»¶è¿Ÿ

å¦‚æœæœ‰å»¶è¿Ÿï¼Œæ£€æŸ¥ï¼š
- WebSocket è¿æ¥çŠ¶æ€
- ç½‘ç»œå»¶è¿Ÿ
- Docker å®¹å™¨æ€§èƒ½

### 3. å­—ç¬¦ä¹±ç 

å¦‚æœæ˜¾ç¤ºä¹±ç ï¼Œæ£€æŸ¥ï¼š
- å­—ç¬¦ç¼–ç ï¼ˆåº”è¯¥æ˜¯ UTF-8ï¼‰
- ç»ˆç«¯é…ç½®
- Docker å®¹å™¨çš„ locale è®¾ç½®

## æ€§èƒ½è€ƒè™‘

### æ–‡æœ¬ vs äºŒè¿›åˆ¶

**Text æ¶ˆæ¯**:
- ä¼˜ç‚¹: è°ƒè¯•æ–¹ä¾¿ï¼Œå¯è¯»æ€§å¥½
- ç¼ºç‚¹: éœ€è¦ UTF-8 ç¼–ç /è§£ç 

**Binary æ¶ˆæ¯**:
- ä¼˜ç‚¹: æ€§èƒ½æ›´å¥½ï¼Œæ”¯æŒä»»æ„å­—èŠ‚
- ç¼ºç‚¹: è°ƒè¯•å›°éš¾

å½“å‰å®ç°ï¼š
- **è¾“å…¥**: æ”¯æŒ Text å’Œ Binary
- **è¾“å‡º**: ä½¿ç”¨ Binaryï¼ˆæ›´é«˜æ•ˆï¼‰

### ä¼˜åŒ–å»ºè®®

å¦‚æœéœ€è¦æ›´å¥½çš„æ€§èƒ½ï¼š

```typescript
// å‰ç«¯æ”¹ä¸ºå‘é€äºŒè¿›åˆ¶
terminal.value?.onData((data) => {
  if (ws.value?.readyState === WebSocket.OPEN) {
    const bytes = new TextEncoder().encode(data)
    ws.value.send(bytes)  // å‘é€äºŒè¿›åˆ¶
  }
})
```

## ç›¸å…³æ–‡ä»¶

- `src-tauri/sentinel-tools/src/terminal/server.rs` - WebSocket æœåŠ¡å™¨ï¼ˆå·²ä¿®å¤ï¼‰
- `src-tauri/sentinel-tools/src/terminal/manager.rs` - ä¼šè¯ç®¡ç†
- `src-tauri/sentinel-tools/src/terminal/session.rs` - ç»ˆç«¯ä¼šè¯
- `src/components/Tools/InteractiveTerminal.vue` - å‰ç«¯ç»„ä»¶

## æ€»ç»“

### é—®é¢˜
- ç»ˆç«¯æ— æ³•è¾“å…¥ï¼Œç”¨æˆ·è¾“å…¥è¢«å¿½ç•¥

### åŸå› 
- æœåŠ¡å™¨åªå¤„ç† Binary æ¶ˆæ¯ï¼Œå¿½ç•¥äº† Text æ¶ˆæ¯
- xterm.js å‘é€çš„æ˜¯ Text æ¶ˆæ¯

### ä¿®å¤
- åœ¨æœåŠ¡å™¨ç«¯æ·»åŠ  Text æ¶ˆæ¯å¤„ç†
- å°†æ–‡æœ¬è½¬æ¢ä¸ºå­—èŠ‚å¹¶å†™å…¥ä¼šè¯

### ç»“æœ
- âœ… ç”¨æˆ·å¯ä»¥æ­£å¸¸è¾“å…¥
- âœ… å‘½ä»¤å¯ä»¥æ‰§è¡Œ
- âœ… è¾“å‡ºæ­£å¸¸æ˜¾ç¤º
- âœ… äº¤äº’å¼å·¥å…·å¯ç”¨

ç°åœ¨ç»ˆç«¯åº”è¯¥å®Œå…¨å¯ç”¨äº†ï¼ğŸ‰
