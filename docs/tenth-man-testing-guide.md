# 第十人原则 - 测试指南

## 🧪 快速测试

### 1. 基础功能测试

#### 测试场景 1: 工具调用前警告

**步骤**:
1. 启用第十人原则（主动介入模式）
2. 设置工具调用间隔为 1
3. 发送消息: "请帮我列出当前目录的文件"

**预期结果**:
- Agent 准备调用工具时，应该看到第十人警告消息
- 警告消息以红色面板显示
- 包含对该操作的质疑

#### 测试场景 2: 结论检测干预

**步骤**:
1. 启用第十人原则（主动介入模式）
2. 发送消息: "分析一下这个系统的安全性"
3. 等待 Agent 给出结论性回答（包含"因此"、"所以"等词）

**预期结果**:
- 当 Agent 使用结论性语句时，第十人应该介入
- 显示对结论的质疑
- 指出可能被忽略的风险

#### 测试场景 3: 危险关键词检测

**步骤**:
1. 在设置中添加危险关键词: `rm -rf, DROP TABLE`
2. 发送消息: "帮我清理一下系统，删除所有临时文件"

**预期结果**:
- 如果 Agent 提到 `rm -rf`，应该触发警告
- 警告应该标注为"危险关键词"触发

### 2. 配置测试

#### 测试配置持久化

**步骤**:
1. 打开设置 → 第十人原则
2. 修改配置:
   - 启用: ✅
   - 模式: 主动介入
   - 工具调用间隔: 3
   - 危险关键词: `rm -rf, DROP TABLE, DELETE FROM`
   - 需要确认: ✅
3. 保存设置
4. 重启应用
5. 再次打开设置

**预期结果**:
- 所有配置应该被正确保存和加载
- 显示"设置已保存"成功提示

### 3. 前端 UI 测试

#### 测试消息显示

**检查项**:
- [ ] 第十人消息有独特的红色样式
- [ ] 显示特殊图标（🕵️ 或类似）
- [ ] 消息内容正确渲染 Markdown
- [ ] 包含触发原因标签

#### 测试事件监听

**步骤**:
1. 打开浏览器开发者工具
2. 切换到 Console 标签
3. 触发第十人审查
4. 查看控制台输出

**预期输出**:
```
[useAgentEvents] Tenth Man warning: shell_execute
[useAgentEvents] Tenth Man intervention: conclusion_detected
```

### 4. 性能测试

#### 测试响应速度

**场景**: 主动介入模式，工具调用间隔 = 1

**测试**:
1. 发送需要多次工具调用的任务
2. 观察第十人审查是否影响整体响应速度

**预期**:
- 第十人审查应该异步执行，不阻塞主流程
- 警告消息应该在工具调用后立即显示
- 不应该明显延迟 Agent 响应

### 5. 边界情况测试

#### 测试 1: 禁用状态

**步骤**:
1. 禁用第十人原则
2. 执行各种操作

**预期**:
- 不应该看到任何第十人消息
- Agent 正常工作

#### 测试 2: 仅最终审查模式

**步骤**:
1. 设置模式为"仅最终审查"
2. 执行包含多个工具调用的任务

**预期**:
- 工具调用过程中不应该有干预
- 只在最终响应时显示审查

#### 测试 3: 空关键词列表

**步骤**:
1. 清空危险关键词列表
2. 执行包含危险操作的任务

**预期**:
- 不应该因为关键词触发警告
- 其他触发条件仍然有效

### 6. 国际化测试

#### 测试中英文切换

**步骤**:
1. 在中文界面下配置第十人原则
2. 切换到英文界面
3. 检查所有文本是否正确翻译

**检查项**:
- [ ] "启用第十人原则" → "Enable Tenth Man Rule"
- [ ] "干预模式" → "Intervention Mode"
- [ ] "主动介入" → "Proactive Intervention"
- [ ] 所有提示文本正确翻译

## 🐛 已知问题

### 1. 用户确认功能未实现

**状态**: 待实现  
**影响**: `require_user_confirmation` 选项目前仅显示警告，不会真正暂停执行

**临时方案**: 用户可以手动点击"停止"按钮

### 2. Realtime 模式未启用

**状态**: 预留接口  
**影响**: 无法选择实时监控模式

**说明**: 实时模式成本较高，暂未实现

## 📊 测试检查清单

### 核心功能
- [ ] 工具调用前触发审查
- [ ] 结论检测触发审查
- [ ] 最终响应触发审查
- [ ] 危险关键词检测
- [ ] 工具调用间隔控制

### 配置管理
- [ ] 配置保存到数据库
- [ ] 配置从数据库加载
- [ ] 配置修改立即生效
- [ ] 默认配置正确

### UI/UX
- [ ] 第十人消息样式正确
- [ ] 消息内容格式化
- [ ] 触发原因显示
- [ ] 国际化文本正确

### 性能
- [ ] 异步执行不阻塞
- [ ] 响应速度可接受
- [ ] 内存使用正常

### 边界情况
- [ ] 禁用状态正常
- [ ] 空配置不报错
- [ ] 无效配置有提示

## 🔍 调试技巧

### 查看后端日志

```bash
tail -f /Users/a1024/code/ai/sentinel-ai/logs/sentinel-ai.log.2026-01-12
```

关键日志:
```
[Plugin] Tenth Man warning before tool call: shell_execute
[Plugin] Tenth Man intervention on conclusion detection
[Plugin] Running Tenth Man Review for execution_id: xxx
```

### 查看前端控制台

打开浏览器开发者工具，过滤关键词:
- `tenth_man`
- `Tenth Man`
- `intervention`

### 数据库查询

```sql
-- 查看第十人配置
SELECT * FROM sentinel_config WHERE category = 'agent' AND key LIKE 'tenth_man%';

-- 查看第十人消息
SELECT * FROM ai_messages WHERE metadata LIKE '%tenth_man%' ORDER BY timestamp DESC LIMIT 10;
```

## 📝 反馈

如果发现问题，请记录:
1. 复现步骤
2. 预期行为
3. 实际行为
4. 相关日志
5. 截图（如果有）

---

**测试版本**: v1.0.0  
**最后更新**: 2026-01-12
