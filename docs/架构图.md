# Sentinel-AI 系统架构图

本文档包含 Sentinel-AI 项目的各个层次的架构图，使用 Mermaid 格式绘制。

## 1. 总体系统架构

```mermaid
graph TB
    subgraph "前端界面层 - Vue 3"
        UI1[AI 聊天界面]
        UI2[插件管理]
        UI3[漏洞发现列表]
        UI4[配置中心]
        UI5[RAG 知识库]
    end
    
    subgraph "Tauri IPC 通信层"
        IPC[命令调用 & 事件流]
    end
    
    subgraph "Rust 后端核心层"
        subgraph "AI 引擎层"
            ENGINE1[ReAct 引擎]
            ENGINE2[Plan-Execute 引擎]
            ENGINE3[LLM Compiler 引擎]
            ENGINE4[ReWOO 引擎]
            ENGINE5[Orchestrator 引擎]
            DISPATCHER[智能调度器]
        end
        
        subgraph "工具调用层 - MCP & Builtin"
            TOOL1[Playwright<br/>浏览器自动化]
            TOOL2[HTTP Request<br/>网络请求]
            TOOL3[File System<br/>文件操作]
            TOOL4[Port Scanner<br/>端口扫描]
            TOOL5[Subdomain Enum<br/>子域名枚举]
            TOOL6[RAG Query<br/>知识库检索]
        end
        
        subgraph "被动扫描层 - 核心创新"
            PROXY[HTTPS 透明代理<br/>Hudsucker + rustls]
            ANALYZER[Website Analyzer<br/>AI 驱动流量分析]
            GENERATOR[Advanced Plugin Generator<br/>LLM 生成插件]
            PLUGINENGINE[Plugin Engine<br/>Deno Core 沙箱]
        end
        
        subgraph "数据持久化层"
            DB1[(SQLite<br/>元数据/配置)]
            DB2[(LanceDB<br/>向量存储)]
            DB3[File Store<br/>插件代码]
        end
    end
    
    subgraph "外部服务"
        LLM[LLM 服务<br/>OpenAI/Anthropic/etc]
        TARGET[目标网站]
    end
    
    UI1 --> IPC
    UI2 --> IPC
    UI3 --> IPC
    UI4 --> IPC
    UI5 --> IPC
    
    IPC --> DISPATCHER
    DISPATCHER --> ENGINE1
    DISPATCHER --> ENGINE2
    DISPATCHER --> ENGINE3
    DISPATCHER --> ENGINE4
    DISPATCHER --> ENGINE5
    
    ENGINE1 --> TOOL1
    ENGINE1 --> TOOL2
    ENGINE2 --> TOOL3
    ENGINE2 --> TOOL4
    ENGINE3 --> TOOL5
    ENGINE3 --> TOOL6
    
    TOOL1 --> PROXY
    TOOL2 --> PROXY
    PROXY --> TARGET
    
    PROXY --> ANALYZER
    ANALYZER --> GENERATOR
    GENERATOR --> LLM
    GENERATOR --> PLUGINENGINE
    
    PLUGINENGINE --> DB1
    ANALYZER --> DB1
    GENERATOR --> DB1
    TOOL6 --> DB2
    PLUGINENGINE --> DB3
    
    style PROXY fill:#ff6b6b
    style ANALYZER fill:#ff6b6b
    style GENERATOR fill:#ff6b6b
    style PLUGINENGINE fill:#ff6b6b
```

## 2. AI 引擎协同架构

```mermaid
graph LR
    subgraph "用户交互"
        USER[用户输入任务]
    end
    
    subgraph "智能调度系统"
        ANALYZER[查询分析器<br/>分析任务特征]
        SELECTOR[引擎选择器<br/>评分与选择]
        QUEUE[任务队列<br/>负载均衡]
    end
    
    subgraph "AI 引擎池"
        subgraph "ReAct 引擎"
            R1[思考]
            R2[行动]
            R3[观察]
            R1 --> R2 --> R3 --> R1
        end
        
        subgraph "Plan-Execute 引擎"
            P1[规划器<br/>生成计划]
            P2[执行器<br/>逐步执行]
            P3[重规划器<br/>错误恢复]
            P1 --> P2
            P2 --> P3
            P3 --> P1
        end
        
        subgraph "LLM Compiler 引擎"
            L1[规划器<br/>生成 DAG]
            L2[任务获取器<br/>拓扑排序]
            L3[并行执行池<br/>最大并发 10]
            L4[结果汇总器]
            L1 --> L2 --> L3 --> L4
        end
        
        subgraph "Orchestrator 引擎"
            O1[ReWOO 子 Agent]
            O2[Plan-Exec 子 Agent]
            O3[Compiler 子 Agent]
            O4[状态管理器]
            O4 --> O1
            O4 --> O2
            O4 --> O3
        end
    end
    
    subgraph "工具执行层"
        TOOLS[统一工具接口<br/>100+ 工具]
    end
    
    USER --> ANALYZER
    ANALYZER --> SELECTOR
    SELECTOR --> QUEUE
    
    QUEUE --> |探索性任务| R1
    QUEUE --> |有序任务| P1
    QUEUE --> |并行任务| L1
    QUEUE --> |复杂测试| O4
    
    R2 --> TOOLS
    P2 --> TOOLS
    L3 --> TOOLS
    O1 --> TOOLS
    O2 --> TOOLS
    O3 --> TOOLS
    
    style R1 fill:#4ecdc4
    style P1 fill:#95e1d3
    style L1 fill:#f38181
    style O4 fill:#aa96da
```

## 3. "Vibe Hacking" 核心流程

```mermaid
sequenceDiagram
    participant User as 用户
    participant Proxy as HTTPS 代理
    participant DB as 流量数据库
    participant Analyzer as Website Analyzer
    participant LLM as LLM 服务
    participant Generator as Plugin Generator
    participant Deno as Deno 引擎
    participant Target as 目标网站
    
    User->>Proxy: 启动被动扫描
    activate Proxy
    
    User->>Target: 浏览器访问网站
    Target-->>Proxy: HTTP 流量经过代理
    Proxy->>DB: 捕获并存储流量
    
    rect rgb(255, 240, 245)
        Note over Analyzer,LLM: 阶段 1: 流量分析与特征提取
        User->>Analyzer: analyze_website(domain)
        Analyzer->>DB: 查询历史流量
        DB-->>Analyzer: 返回流量数据
        
        Analyzer->>Analyzer: 提取 API 端点
        Analyzer->>Analyzer: 识别技术栈
        Analyzer->>Analyzer: 分析参数类型
        Analyzer-->>User: 返回网站分析结果<br/>{endpoints, tech_stack, params}
    end
    
    rect rgb(240, 255, 245)
        Note over Generator,Deno: 阶段 2: AI 插件生成
        User->>Generator: generate_advanced_plugin(analysis, vuln_types)
        Generator->>Generator: 构建 Few-shot Prompt
        Generator->>LLM: 发送生成请求
        LLM-->>Generator: 返回 TypeScript 代码
        
        Generator->>Generator: 代码验证
        alt 验证失败
            Generator->>LLM: 发送修复请求
            LLM-->>Generator: 返回修复后代码
        end
        
        Generator->>Generator: 质量评分
        Generator->>DB: 存储插件
        Generator-->>User: 返回生成结果
    end
    
    rect rgb(255, 255, 240)
        Note over Deno,Target: 阶段 3: 插件加载与执行
        User->>Deno: 启用插件
        Deno->>DB: 加载插件代码
        Deno->>Deno: 创建隔离沙箱
        
        Target-->>Proxy: 后续流量
        Proxy->>Deno: 调用 scan_request()
        Deno->>Deno: 执行检测逻辑
        
        alt 发现漏洞
            Deno->>DB: op_emit_finding()
            DB-->>User: 推送漏洞告警
        end
    end
    
    deactivate Proxy
```

## 4. 被动扫描详细架构

```mermaid
graph TB
    subgraph "流量入口"
        BROWSER[浏览器]
        SCRIPT[自动化脚本]
    end
    
    subgraph "HTTPS 代理层 - Hudsucker"
        LISTENER[监听器<br/>:4201]
        MITM[MITM 证书管理<br/>rustls + rcgen]
        DECODER[请求/响应解码<br/>gzip/brotli/chunked]
    end
    
    subgraph "流量分析层"
        CAPTURE[流量捕获器]
        PARSER[协议解析器<br/>HTTP/1.1, HTTP/2]
        EXTRACTOR[特征提取器]
        
        subgraph "Website Analyzer - AI 驱动"
            A1[端点提取器]
            A2[技术栈识别器]
            A3[参数分析器]
            A4[认证机制检测器]
        end
    end
    
    subgraph "插件生成层"
        subgraph "Prompt Builder"
            PB1[模板管理器]
            PB2[Few-shot 示例库]
            PB3[上下文构建器]
        end
        
        LLMCLIENT[LLM 客户端<br/>支持多提供商]
        
        subgraph "代码处理"
            VALIDATOR[语法验证器]
            FIXER[自动修复器<br/>最多 3 次]
            SCORER[质量评分器]
        end
    end
    
    subgraph "插件执行层 - Deno Core"
        RUNTIME[V8 隔离运行时]
        REGISTRY[插件注册表]
        
        subgraph "内置 API"
            API1[fetch]
            API2[TextDecoder/Encoder]
            API3[URL/URLSearchParams]
            API4[op_emit_finding]
            API5[op_plugin_log]
        end
        
        subgraph "插件实例"
            PLUGIN1[通用插件<br/>SQL 注入检测]
            PLUGIN2[通用插件<br/>XSS 检测]
            PLUGIN3[AI 生成插件<br/>针对特定网站]
        end
    end
    
    subgraph "数据存储"
        DB_HTTP[(http_requests<br/>http_responses)]
        DB_FINDING[(findings)]
        DB_PLUGIN[(plugins)]
        DB_ANALYSIS[(website_analysis)]
    end
    
    BROWSER --> LISTENER
    SCRIPT --> LISTENER
    LISTENER --> MITM
    MITM --> DECODER
    DECODER --> CAPTURE
    
    CAPTURE --> PARSER
    PARSER --> EXTRACTOR
    EXTRACTOR --> DB_HTTP
    
    EXTRACTOR --> A1
    EXTRACTOR --> A2
    EXTRACTOR --> A3
    EXTRACTOR --> A4
    
    A1 --> DB_ANALYSIS
    A2 --> DB_ANALYSIS
    A3 --> DB_ANALYSIS
    A4 --> DB_ANALYSIS
    
    DB_ANALYSIS --> PB3
    PB1 --> PB3
    PB2 --> PB3
    PB3 --> LLMCLIENT
    
    LLMCLIENT --> VALIDATOR
    VALIDATOR --> |失败| FIXER
    FIXER --> LLMCLIENT
    VALIDATOR --> |成功| SCORER
    SCORER --> DB_PLUGIN
    
    DB_PLUGIN --> RUNTIME
    RUNTIME --> REGISTRY
    REGISTRY --> PLUGIN1
    REGISTRY --> PLUGIN2
    REGISTRY --> PLUGIN3
    
    RUNTIME --> API1
    RUNTIME --> API2
    RUNTIME --> API3
    RUNTIME --> API4
    RUNTIME --> API5
    
    PARSER --> PLUGIN1
    PARSER --> PLUGIN2
    PARSER --> PLUGIN3
    
    API4 --> DB_FINDING
    
    style MITM fill:#ffe66d
    style A1 fill:#ff6b6b
    style A2 fill:#ff6b6b
    style A3 fill:#ff6b6b
    style A4 fill:#ff6b6b
    style LLMCLIENT fill:#4ecdc4
    style RUNTIME fill:#95e1d3
```

## 5. 数据库 E-R 图

```mermaid
erDiagram
    AI_PROVIDERS ||--o{ AI_SESSIONS : uses
    AI_PROVIDERS {
        string id PK
        string provider
        string name
        string api_key
        string base_url
        boolean is_active
    }
    
    AI_SESSIONS ||--o{ AGENT_MESSAGES : contains
    AI_SESSIONS {
        string id PK
        string title
        string provider_id FK
        string model
        datetime created_at
    }
    
    AGENT_MESSAGES {
        string id PK
        string session_id FK
        string role
        text content
        text tool_calls
        datetime timestamp
    }
    
    PLUGINS ||--o{ FINDINGS : detects
    PLUGINS {
        string id PK
        string name
        string version
        string category
        text code
        string status
        float quality_score
        datetime created_at
    }
    
    HTTP_REQUESTS ||--|| HTTP_RESPONSES : paired
    HTTP_REQUESTS ||--o{ FINDINGS : triggers
    HTTP_REQUESTS {
        string id PK
        string url
        string method
        text headers
        blob body
        datetime timestamp
    }
    
    HTTP_RESPONSES {
        string request_id PK_FK
        int status
        text headers
        blob body
        datetime timestamp
    }
    
    FINDINGS {
        string id PK
        string request_id FK
        string plugin_id FK
        string vuln_type
        string severity
        string confidence
        text evidence
        text description
        datetime detected_at
    }
    
    WEBSITE_ANALYSIS {
        string id PK
        string domain
        json endpoints
        json tech_stack
        json parameters
        json auth_mechanisms
        datetime analyzed_at
    }
    
    PROMPTS {
        string id PK
        string name
        string template_type
        text content
        int priority
        boolean is_active
        boolean is_default
    }
    
    RAG_DOCUMENTS {
        string id PK
        string file_path
        string file_type
        text content
        vector embedding
        json metadata
        datetime imported_at
    }
    
    TEST_SESSIONS ||--o{ TEST_STEPS : contains
    TEST_SESSIONS ||--o{ FINDINGS : discovers
    TEST_SESSIONS {
        string id PK
        string task_kind
        string primary_target
        string current_stage
        json auth_context
        datetime started_at
    }
    
    TEST_STEPS {
        string id PK
        string session_id FK
        string step_type
        string sub_agent
        string status
        text output
        datetime started_at
    }
```

## 6. LLM Compiler 并行执行流程

```mermaid
graph TD
    START[用户任务] --> PLANNER[Planner<br/>生成 DAG 任务图]
    
    PLANNER --> DAG{构建依赖图}
    
    DAG --> T1[Task 1<br/>扫描目标 A]
    DAG --> T2[Task 2<br/>扫描目标 B]
    DAG --> T3[Task 3<br/>扫描目标 C]
    DAG --> T4[Task 4<br/>扫描目标 D]
    DAG --> T5[Task 5<br/>扫描目标 E]
    
    T1 --> FETCHER[Task Fetching Unit<br/>拓扑排序]
    T2 --> FETCHER
    T3 --> FETCHER
    T4 --> FETCHER
    T5 --> FETCHER
    
    FETCHER --> LEVEL0{Level 0<br/>无依赖}
    
    LEVEL0 --> |并行执行| EXEC1[Executor 1<br/>Task 1]
    LEVEL0 --> |并行执行| EXEC2[Executor 2<br/>Task 2]
    LEVEL0 --> |并行执行| EXEC3[Executor 3<br/>Task 3]
    LEVEL0 --> |并行执行| EXEC4[Executor 4<br/>Task 4]
    LEVEL0 --> |并行执行| EXEC5[Executor 5<br/>Task 5]
    
    EXEC1 --> R1[Result 1]
    EXEC2 --> R2[Result 2]
    EXEC3 --> R3[Result 3]
    EXEC4 --> R4[Result 4]
    EXEC5 --> R5[Result 5]
    
    R1 --> JOINER[Intelligent Joiner<br/>汇总结果]
    R2 --> JOINER
    R3 --> JOINER
    R4 --> JOINER
    R5 --> JOINER
    
    JOINER --> LLM[调用 LLM<br/>生成最终报告]
    LLM --> OUTPUT[返回用户]
    
    style EXEC1 fill:#95e1d3
    style EXEC2 fill:#95e1d3
    style EXEC3 fill:#95e1d3
    style EXEC4 fill:#95e1d3
    style EXEC5 fill:#95e1d3
    style JOINER fill:#f38181
```

## 7. 完整安全测试工作流

```mermaid
stateDiagram-v2
    [*] --> Idle: 应用启动
    
    Idle --> ProxyStarting: 用户发起测试请求
    ProxyStarting --> ProxyRunning: 代理启动成功
    ProxyRunning --> TrafficCapture: 开始捕获流量
    
    TrafficCapture --> Analyzing: 分析网站结构
    Analyzing --> PluginGenerating: AI 生成检测插件
    
    PluginGenerating --> PluginReview: 插件待审核
    PluginReview --> PluginActive: 用户批准启用
    PluginReview --> PluginRejected: 用户拒绝
    PluginRejected --> PluginGenerating: 重新生成
    
    PluginActive --> AutoTesting: 执行自动化测试
    AutoTesting --> ScanningRequests: 扫描请求
    AutoTesting --> ScanningResponses: 扫描响应
    
    ScanningRequests --> DetectingVulns: 检测漏洞
    ScanningResponses --> DetectingVulns
    
    DetectingVulns --> FindingEmitted: 发现漏洞
    FindingEmitted --> ReportGeneration: 生成报告
    
    DetectingVulns --> NoVulnFound: 未发现漏洞
    NoVulnFound --> ReportGeneration
    
    ReportGeneration --> Cleanup: 清理资源
    Cleanup --> [*]: 测试完成
    
    state AutoTesting {
        [*] --> Playwright
        Playwright --> FillForm
        FillForm --> ClickButton
        ClickButton --> NavigatePages
        NavigatePages --> [*]
    }
    
    state DetectingVulns {
        [*] --> CheckSQL
        [*] --> CheckXSS
        [*] --> CheckIDOR
        [*] --> CheckAuthBypass
        CheckSQL --> [*]
        CheckXSS --> [*]
        CheckIDOR --> [*]
        CheckAuthBypass --> [*]
    }
```

## 8. RAG 知识增强系统

```mermaid
graph LR
    subgraph "知识导入"
        DOC1[PDF 文档]
        DOC2[Markdown 文档]
        DOC3[DOCX 文档]
        DOC4[历史漏洞报告]
    end
    
    subgraph "文档处理"
        PARSER[文档解析器]
        CHUNKER[文本分块器<br/>500 字符, 重叠 50]
        EMBEDDER[Embedding 生成器<br/>OpenAI text-embedding-3]
    end
    
    subgraph "向量存储 - LanceDB"
        VECTOR[(向量表<br/>security_knowledge)]
        INDEX[IVFPQ 索引]
    end
    
    subgraph "实时检索"
        QUERY[用户查询]
        QUERY_EMB[查询向量化]
        SEARCH[相似度搜索<br/>Top-K]
        RERANK[重排序<br/>多样性过滤]
    end
    
    subgraph "AI 增强"
        CONTEXT[构建上下文]
        LLM_CALL[LLM 调用<br/>注入检索结果]
        ANSWER[生成答案]
    end
    
    DOC1 --> PARSER
    DOC2 --> PARSER
    DOC3 --> PARSER
    DOC4 --> PARSER
    
    PARSER --> CHUNKER
    CHUNKER --> EMBEDDER
    EMBEDDER --> VECTOR
    VECTOR --> INDEX
    
    QUERY --> QUERY_EMB
    QUERY_EMB --> SEARCH
    SEARCH --> INDEX
    INDEX --> RERANK
    
    RERANK --> CONTEXT
    CONTEXT --> LLM_CALL
    LLM_CALL --> ANSWER
    
    style VECTOR fill:#4ecdc4
    style LLM_CALL fill:#ff6b6b
```

## 9. 部署架构

```mermaid
graph TB
    subgraph "桌面版部署"
        DESKTOP[Tauri 桌面应用<br/>Windows/macOS/Linux]
        LOCAL_DB[(本地 SQLite<br/>LanceDB)]
        DESKTOP --> LOCAL_DB
    end
    
    subgraph "云服务版部署"
        LB[负载均衡器<br/>Nginx]
        
        subgraph "应用层"
            WEB1[Web 服务 1]
            WEB2[Web 服务 2]
            WEB3[Web 服务 3]
        end
        
        subgraph "数据层"
            REDIS[(Redis<br/>缓存/会话)]
            POSTGRES[(PostgreSQL<br/>主数据库)]
            S3[(对象存储<br/>插件代码/报告)]
            LANCE_CLOUD[(LanceDB Cloud<br/>向量数据库)]
        end
        
        LB --> WEB1
        LB --> WEB2
        LB --> WEB3
        
        WEB1 --> REDIS
        WEB2 --> REDIS
        WEB3 --> REDIS
        
        WEB1 --> POSTGRES
        WEB2 --> POSTGRES
        WEB3 --> POSTGRES
        
        WEB1 --> S3
        WEB2 --> S3
        WEB3 --> S3
        
        WEB1 --> LANCE_CLOUD
        WEB2 --> LANCE_CLOUD
        WEB3 --> LANCE_CLOUD
    end
    
    subgraph "Kubernetes 部署"
        INGRESS[Ingress<br/>Traefik]
        
        subgraph "Pods"
            POD1[sentinel-ai-1]
            POD2[sentinel-ai-2]
            POD3[sentinel-ai-3]
        end
        
        subgraph "有状态服务"
            PVC[(Persistent Volume<br/>数据持久化)]
        end
        
        INGRESS --> POD1
        INGRESS --> POD2
        INGRESS --> POD3
        
        POD1 --> PVC
        POD2 --> PVC
        POD3 --> PVC
    end
    
    subgraph "外部依赖"
        LLM_API[LLM API<br/>OpenAI/Anthropic]
        MONITORING[监控告警<br/>Prometheus + Grafana]
    end
    
    WEB1 --> LLM_API
    WEB2 --> LLM_API
    WEB3 --> LLM_API
    
    POD1 --> LLM_API
    POD2 --> LLM_API
    POD3 --> LLM_API
    
    WEB1 --> MONITORING
    POD1 --> MONITORING
    
    style DESKTOP fill:#95e1d3
    style LB fill:#4ecdc4
    style INGRESS fill:#4ecdc4
```

## 10. 技术栈全景图

```mermaid
mindmap
  root((Sentinel-AI))
    前端技术栈
      Vue 3
        Composition API
        script setup
      TypeScript
      TailwindCSS
        DaisyUI
      构建工具
        Vite
        Vue Router
        Pinia
      编辑器
        CodeMirror 6
      可视化
        Chart.js
        vue-chartjs
    
    后端技术栈
      Rust
        Tauri 2.0
        Tokio 异步运行时
      数据库
        SQLx + SQLite
        LanceDB 向量数据库
      网络
        Reqwest HTTP 客户端
        Hudsucker HTTPS 代理
        rustls TLS
      插件引擎
        Deno Core
        V8 隔离沙箱
      AI 框架
        Rig LLM 工具库
        rig-lancedb
    
    AI 能力
      LLM 提供商
        OpenAI GPT-4
        Anthropic Claude
        Google Gemini
        DeepSeek
        Ollama 本地
      AI 引擎
        ReAct
        Plan-and-Execute
        LLM Compiler
        ReWOO
        Orchestrator
      RAG
        文档解析
        向量检索
        知识增强
    
    协议与集成
      MCP 协议
        rmcp SDK
        Playwright MCP
        File System MCP
      安全工具
        端口扫描 rustscan
        子域名枚举 rsubdomain
        DNS 解析 hickory-resolver
    
    DevOps
      版本控制
        Git
      CI/CD
        GitHub Actions
      测试
        Rust cargo test
        Vitest
        Playwright E2E
      部署
        Docker
        Kubernetes
        原生安装包
```

---

## 使用说明

这些架构图可以直接在支持 Mermaid 的 Markdown 编辑器中查看，如：
- GitHub
- GitLab
- VS Code（需安装 Mermaid 插件）
- Typora
- Obsidian

也可以使用在线工具预览：
- https://mermaid.live/
- https://mermaid.ink/

## 架构图说明

1. **总体系统架构**：展示了从前端到后端的完整层次结构
2. **AI 引擎协同架构**：展示了 5 种 AI 引擎的工作方式和智能调度机制
3. **"Vibe Hacking" 核心流程**：时序图展示了从流量捕获到插件生成的完整过程
4. **被动扫描详细架构**：核心创新模块的详细实现
5. **数据库 E-R 图**：展示了所有数据表及其关系
6. **LLM Compiler 并行执行流程**：展示了并行任务调度的实现
7. **完整安全测试工作流**：状态图展示了测试的完整生命周期
8. **RAG 知识增强系统**：展示了知识库的构建和检索流程
9. **部署架构**：展示了桌面版、云服务版和 K8s 部署方案
10. **技术栈全景图**：思维导图展示了所有使用的技术

---

**文档版本**：v1.0  
**创建日期**：2025-11-19  
**维护者**：Sentinel-AI 团队

