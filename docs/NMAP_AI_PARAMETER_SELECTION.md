# Nmap AI 参数选择功能

## 功能概述

我们为Sentinel AI的nmap工具调用实现了智能参数选择功能。现在，AI可以根据用户的自然语言描述和需求，智能地选择最合适的nmap扫描参数，而不是使用固定的参数集。

## 实现方式

### 1. 扩展的参数选项

nmap工具现在支持以下参数：

- **target**: 扫描目标IP、域名或网段（必需）
- **ports**: 要扫描的端口范围，如'1-1000'、'22,80,443'
- **scan_type**: 扫描类型，如'-sS'(SYN)、'-sT'(TCP)、'-sU'(UDP)等
- **timing_template**: 扫描速度模板，如'-T0'到'-T5'
- **script**: 要运行的NSE脚本，如'--script=default'、'vuln'、'discovery'
- **intensity**: 扫描强度预设，AI会根据此参数智能选择合适的参数组合
- **additional_options**: 其他nmap命令行选项

### 2. 智能强度预设

我们实现了四种扫描强度预设，AI可以根据用户需求自动选择：

1. **light**: 轻量扫描
   - 快速扫描常见端口
   - 使用-T3速度模板
   - 仅执行SYN扫描

2. **normal**: 标准扫描
   - 扫描前1000个端口
   - 使用-T4速度模板
   - 执行SYN扫描和服务版本检测

3. **aggressive**: 积极扫描
   - 扫描前10000个端口
   - 使用-T4速度模板
   - 执行SYN扫描和服务版本检测
   - 运行默认NSE脚本

4. **comprehensive**: 全面扫描
   - 全端口扫描
   - 使用-T4速度模板
   - 执行SYN扫描、服务版本检测和操作系统检测
   - 运行漏洞检测脚本

### 3. 参数解析和处理

工具执行器现在能够智能处理各种参数格式：

- 自动检测参数是否包含前缀（如'-p'、'-T'等）
- 支持多个空格分隔的参数
- 智能组合多个扫描类型参数

## 使用示例

### 示例1: 轻量扫描

**用户输入**:
```
帮我快速扫描一下本地主机的常见端口
```

**AI解析**:
- 用户需求：快速扫描、常见端口
- 选择强度：light

**执行命令**:
```
nmap -v -T3 -F -sS -oX - 127.0.0.1
```

### 示例2: 标准扫描

**用户输入**:
```
扫描我的服务器开放了哪些端口
```

**AI解析**:
- 用户需求：常规端口扫描
- 选择强度：normal

**执行命令**:
```
nmap -v -T4 -p 1-1000 -sS -sV -oX - 192.168.1.1
```

### 示例3: 全面扫描

**用户输入**:
```
对目标服务器进行全面的安全扫描，包括漏洞检测
```

**AI解析**:
- 用户需求：全面扫描、漏洞检测
- 选择强度：comprehensive

**执行命令**:
```
nmap -v -T4 -p- -sS -sV -O --script=vuln -oX - 192.168.1.1
```

### 示例4: 自定义参数

**用户输入**:
```
使用nmap扫描目标的UDP服务
```

**AI解析**:
- 用户需求：UDP扫描
- 直接指定scan_type参数

**执行命令**:
```
nmap -v -T4 -sU -oX - 192.168.1.1
```

## 安全考虑

为了确保安全和合理使用，我们实施了以下限制：

1. 所有参数都经过严格验证，防止命令注入
2. 扫描参数组合经过优化，避免过于激进的扫描
3. 对于高强度扫描，AI会提醒用户可能需要较长时间
4. 对于特权操作（如操作系统检测），AI会提醒用户可能需要管理员权限

## 技术实现

### 参数映射

```rust
// 将intensity参数映射到具体的nmap参数组合
let scan_profile = match intensity {
    "light" => {
        json!({
            "timing_template": "-T3",
            "ports": "-F", // 快速扫描模式
            "scan_type": "-sS" // SYN扫描
        })
    },
    "normal" => {
        json!({
            "timing_template": "-T4",
            "ports": "-p 1-1000",
            "scan_type": "-sS -sV" // SYN扫描 + 服务版本检测
        })
    },
    // ...更多强度级别
}
```

### 参数处理

```rust
// 处理端口参数
if let Some(ports) = options.get("ports") {
    if let Some(ports_str) = ports.as_str() {
        // 检查是否已经包含-p前缀
        if ports_str.starts_with("-p") || ports_str.starts_with("-F") {
            for arg in ports_str.split_whitespace() {
                cmd.arg(arg);
            }
        } else {
            cmd.arg("-p");
            cmd.arg(ports_str);
        }
    }
}
```

## 未来改进

1. **更多扫描预设**: 添加针对特定场景的扫描预设，如Web应用扫描、IoT设备扫描等
2. **自适应参数**: 根据之前的扫描结果自动调整参数
3. **智能超时控制**: 根据目标响应时间动态调整扫描超时
4. **学习用户偏好**: 记住用户常用的扫描参数组合
5. **扫描结果增强**: 提供更详细的扫描结果分析和可视化

## 结论

通过实现AI智能参数选择功能，Sentinel AI现在能够根据用户的自然语言描述自动选择最合适的nmap扫描参数。这使得安全扫描更加直观、高效，同时保持了专业性和灵活性。用户可以使用简单的自然语言表达他们的需求，而无需了解复杂的nmap命令行参数。 