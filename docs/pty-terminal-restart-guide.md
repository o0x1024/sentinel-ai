# PTY ç»ˆç«¯é‡å¯å’Œæµ‹è¯•æŒ‡å—

## ğŸ¯ é—®é¢˜æ€»ç»“

ä»ä½ çš„æˆªå›¾å‘ç°äº†ä¸¤ä¸ªé—®é¢˜ï¼š

### é—®é¢˜ 1: äº¤äº’å¼ç»ˆç«¯æ²¡æœ‰æ˜¾ç¤ºç¬¬ä¸€æ¬¡æ‰§è¡Œçš„å‘½ä»¤å’Œç»“æœ
**ç°è±¡**ï¼š
- å·¦ä¾§æ˜¾ç¤ºå·¥å…·æ‰§è¡ŒæˆåŠŸï¼Œè¿”å›äº† `session_id: c07e56c6`
- å·¦ä¾§æ˜¾ç¤ºç»“æœï¼š"æ‰§è¡Œ whoami çš„ç»“æœä¸ºï¼šsandbox"
- å³ä¾§ç»ˆç«¯é¢æ¿åªæ˜¾ç¤º promptï¼Œæ²¡æœ‰æ˜¾ç¤º "whoami" å‘½ä»¤å’Œ "sandbox" è¾“å‡º

**åŸå› **ï¼š
- åº”ç”¨è¿˜åœ¨è¿è¡Œ**æ—§ç‰ˆæœ¬**ï¼ˆpipe æ¨¡å¼ï¼‰
- æ—§ç‰ˆæœ¬æœ‰ Broken Pipe é—®é¢˜ï¼Œè¾“å‡ºæ²¡æœ‰è¢«ä¿å­˜åˆ°å†å²
- éœ€è¦è¿è¡Œæ–°ç‰ˆæœ¬ï¼ˆPTY æ¨¡å¼ï¼‰

### é—®é¢˜ 2: è¿”å›ç»“æœä¸­å­˜åœ¨æ— æ„ä¹‰çš„ç¼–ç å­—ç¬¦
**ç°è±¡**ï¼š
```json
{
  "text": "{\"success\":true,\"session_id\":\"9c07dfed...\",
   \"command\":\"whoami\",\"output\":\"whoami\\r\\n\\u001b[?2004h\\u001b]0..."
}
```

**åŸå› **ï¼š
- PTY æ¨¡å¼ä¼šäº§ç”Ÿ ANSI è½¬ä¹‰åºåˆ—ï¼ˆç”¨äºé¢œè‰²ã€å…‰æ ‡æ§åˆ¶ç­‰ï¼‰
- è¿™äº›åºåˆ—å¯¹ç»ˆç«¯æ˜¾ç¤ºæœ‰ç”¨ï¼Œä½†ä¸åº”è¯¥è¿”å›ç»™ LLM

**å·²ä¿®å¤**ï¼š
- æ·»åŠ äº† `strip_ansi_codes()` å‡½æ•°
- è¿”å›ç»™ LLM çš„ç»“æœä¼šè‡ªåŠ¨è¿‡æ»¤ ANSI åºåˆ—
- ç»ˆç«¯é¢æ¿ä»ç„¶æ¥æ”¶åŸå§‹è¾“å‡ºï¼ˆä¿ç•™é¢œè‰²å’Œæ ¼å¼ï¼‰

---

## ğŸ”§ å¿…é¡»æ“ä½œï¼šé‡å¯åº”ç”¨

### æ­¥éª¤ 1: åœæ­¢å½“å‰åº”ç”¨

```bash
# æ–¹å¼ A: æŸ¥æ‰¾è¿›ç¨‹å¹¶åœæ­¢
ps aux | grep sentinel-ai | grep -v grep
kill 48463  # æ›¿æ¢ä¸ºä½ çš„è¿›ç¨‹ ID

# æ–¹å¼ B: åœ¨åº”ç”¨ç•Œé¢ç›´æ¥é€€å‡º
```

### æ­¥éª¤ 2: ç¡®è®¤ç¼–è¯‘æˆåŠŸ

```bash
cd /Users/a1024/code/ai/sentinel-ai/src-tauri
cargo build

# åº”è¯¥æ˜¾ç¤ºï¼š
# Finished `dev` profile [unoptimized] target(s) in XX.XXs
```

âœ… å·²å®Œæˆï¼

### æ­¥éª¤ 3: é‡æ–°å¯åŠ¨åº”ç”¨

```bash
# æ–¹å¼ A: é€šè¿‡ VS Code è°ƒè¯•é¢æ¿å¯åŠ¨ï¼ˆæ¨èï¼‰
# ç‚¹å‡»è°ƒè¯•æŒ‰é’® (F5)

# æ–¹å¼ B: å‘½ä»¤è¡Œå¯åŠ¨
cd /Users/a1024/code/ai/sentinel-ai/src-tauri
cargo run
```

---

## ğŸ§ª é‡å¯åçš„æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1: éªŒè¯ PTY æ¨¡å¼å¯åŠ¨

**å¯åŠ¨åæ£€æŸ¥æ—¥å¿—**ï¼š
```bash
tail -f /Users/a1024/code/ai/sentinel-ai/logs/sentinel-ai.log.2026-01-12
```

**åº”è¯¥çœ‹åˆ°ï¼ˆæ–°æ—¥å¿—ï¼‰**ï¼š
```
[INFO] Initializing global TerminalSessionManager  â† æ–°åŠŸèƒ½
[INFO] Terminal session started with PTY: xxx      â† æ–°æ—¥å¿—ï¼
```

**å¦‚æœæ²¡çœ‹åˆ°**ï¼šè¯´æ˜è¿˜åœ¨è¿è¡Œæ—§ç‰ˆæœ¬ï¼Œéœ€è¦ç¡®è®¤è¿›ç¨‹å·²åœæ­¢ã€‚

---

### æµ‹è¯• 2: åŸºç¡€å‘½ä»¤æ‰§è¡Œ

1. **å‘é€æ¶ˆæ¯**ï¼š"æ‰§è¡Œä¸€ä¸‹ whoami"
2. **é¢„æœŸç»“æœ**ï¼š

**å·¦ä¾§æ¶ˆæ¯åŒº**ï¼š
```
> interactive_shell
âœ“ å·²å®Œæˆ

æ‰§è¡Œ whoami çš„ç»“æœä¸ºï¼š sandbox  â† æ²¡æœ‰è½¬ä¹‰åºåˆ—ï¼
```

**å³ä¾§ç»ˆç«¯é¢æ¿**ï¼š
```
Sentinel AI Interactive Terminal
Connecting to terminal server...
âœ“ Connected!

â”€(sandbox@ 8cd3d68b7276)â”€[/workspace]
$ whoami          â† å‘½ä»¤å¯è§ï¼
sandbox           â† è¾“å‡ºå¯è§ï¼
â”€(sandbox@ 8cd3d68b7276)â”€[/workspace]
$ _
```

**å‰ç«¯æ§åˆ¶å°**ï¼š
```javascript
[Agent] interactive_shell result parsed, session_id: xxx  â† æœ‰å€¼
[Agent] âœ… Terminal opened with session_id: xxx
[Terminal] Connecting to existing session: xxx
[Terminal] Received output, length: X  â† æ”¶åˆ°æ•°æ®
```

**åç«¯æ—¥å¿—**ï¼š
```
[INFO] Terminal session started with PTY: xxx
[INFO] Created new persistent terminal session: xxx
[INFO] [Terminal Session xxx] Adding subscriber, history chunks: 1
[INFO] [Terminal Session xxx] Sending history chunk 0: X bytes
[INFO] [WS Session xxx] Forwarding chunk #1: X bytes
```

---

### æµ‹è¯• 3: è¿ç»­å‘½ä»¤ï¼ˆä¼šè¯æŒä¹…æ€§ï¼‰

1. **å‘é€**ï¼š"æ‰§è¡Œä¸€ä¸‹ pwd"
2. **é¢„æœŸ**ï¼š
   - ç»ˆç«¯æ˜¾ç¤ºå®Œæ•´çš„ `pwd` å‘½ä»¤å’Œ `/workspace` è¾“å‡º
   - LLM ç»“æœä¸åŒ…å«è½¬ä¹‰åºåˆ—

3. **å‘é€**ï¼š"æ‰§è¡Œä¸€ä¸‹ ping -c 3 baidu.com"
4. **é¢„æœŸ**ï¼š
   - å®æ—¶æ˜¾ç¤º ping è¾“å‡º
   - æ¯ç§’æ›´æ–°ä¸€æ¬¡
   - å¸¦é¢œè‰²ï¼ˆç»ˆç«¯ä¸­ï¼‰
   - LLM æ”¶åˆ°çº¯æ–‡æœ¬ç»“æœ

---

## ğŸ“Š å¯¹æ¯”ï¼šæ—§ç‰ˆæœ¬ vs æ–°ç‰ˆæœ¬

### å·¦ä¾§è¿”å›ç»“æœ

**æ—§ç‰ˆæœ¬ï¼ˆé—®é¢˜ï¼‰**ï¼š
```json
{
  "output": "whoami\\r\\n\\u001b[?2004h\\u001b]0;sandbox@427103bfc335: /workspace\\u0007\\u001b[01;34m@\\u001b[00m..."
}
```
âŒ å¤§é‡ ANSI è½¬ä¹‰åºåˆ—
âŒ LLM éš¾ä»¥ç†è§£

**æ–°ç‰ˆæœ¬ï¼ˆä¿®å¤åï¼‰**ï¼š
```json
{
  "output": "whoami\nsandbox\n"
}
```
âœ… çº¯æ–‡æœ¬è¾“å‡º
âœ… LLM å¯ä»¥æ­£ç¡®ç†è§£

---

### ç»ˆç«¯æ˜¾ç¤º

**æ—§ç‰ˆæœ¬ï¼ˆé—®é¢˜ï¼‰**ï¼š
```
âœ“ Connected!

[ç©ºç™½]
```
âŒ æ²¡æœ‰å†å²è¾“å‡º
âŒ çœ‹ä¸åˆ°å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹

**æ–°ç‰ˆæœ¬ï¼ˆä¿®å¤åï¼‰**ï¼š
```
âœ“ Connected!

â”€(sandbox@ 8cd3d68b7276)â”€[/workspace]
$ whoami
sandbox
â”€(sandbox@ 8cd3d68b7276)â”€[/workspace]
$ _
```
âœ… å®Œæ•´çš„å‘½ä»¤å’Œè¾“å‡º
âœ… å¸¦é¢œè‰²çš„ prompt
âœ… å…‰æ ‡é—ªçƒ

---

## ğŸ” å¦‚ä½•ç¡®è®¤æ–°ç‰ˆæœ¬æ­£åœ¨è¿è¡Œ

### æ£€æŸ¥ç‚¹ 1: è¿›ç¨‹å¯åŠ¨æ—¶é—´

```bash
ps aux | grep sentinel-ai | grep -v grep

# è¾“å‡ºåº”è¯¥æ˜¾ç¤ºï¼š
a1024  XXXXX  ...  5:10PM  ...  /target/debug/sentinel-ai
                    ^^^^^^
                    åº”è¯¥æ˜¯é‡å¯åçš„æ—¶é—´
```

### æ£€æŸ¥ç‚¹ 2: æ—¥å¿—å†…å®¹

```bash
tail -50 ~/logs/sentinel-ai.log.2026-01-12 | grep -E "PTY|Terminal session started"

# åº”è¯¥çœ‹åˆ°ï¼š
[INFO] Terminal session started with PTY: xxx  â† å…³é”®æ ‡å¿—
```

### æ£€æŸ¥ç‚¹ 3: å·¥å…·è¿”å›æ ¼å¼

**æ—§ç‰ˆæœ¬**ï¼š
- è¿”å›ç»“æœåŒ…å« `\u001b[` ç­‰è½¬ä¹‰åºåˆ—

**æ–°ç‰ˆæœ¬**ï¼š
- è¿”å›ç»“æœæ˜¯çº¯æ–‡æœ¬
- `session_id` å­˜åœ¨ä¸”æœ‰æ•ˆ

---

## âœ… æˆåŠŸæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹æ‰€æœ‰ç°è±¡æ—¶ï¼Œè¯´æ˜ PTY æ¨¡å¼æ­£å¸¸å·¥ä½œï¼š

- [ ] åç«¯æ—¥å¿—æ˜¾ç¤º "Terminal session started with PTY"
- [ ] å·¦ä¾§å·¥å…·ç»“æœ**æ²¡æœ‰** ANSI è½¬ä¹‰åºåˆ—
- [ ] å³ä¾§ç»ˆç«¯æ˜¾ç¤º**å®Œæ•´çš„**å‘½ä»¤å’Œè¾“å‡º
- [ ] ç»ˆç«¯ prompt å¸¦æœ‰**é¢œè‰²**
- [ ] å¯ä»¥åœ¨ç»ˆç«¯ä¸­**è¾“å…¥å‘½ä»¤**å¹¶çœ‹åˆ°æ‰§è¡Œç»“æœ
- [ ] è¿ç»­æ‰§è¡Œå‘½ä»¤æ—¶ä¼šè¯ä¿æŒï¼ˆä¸ä¼šåˆ›å»ºå¤šä¸ªå®¹å™¨ï¼‰

---

## ğŸ› å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

### é—®é¢˜ A: ä»ç„¶æ²¡æœ‰å†å²è¾“å‡º

**æ£€æŸ¥**ï¼š
```bash
# 1. ç¡®è®¤ PTY æ¨¡å¼
grep "PTY" ~/logs/sentinel-ai.log.2026-01-12

# 2. æ£€æŸ¥ä¼šè¯å¥åº·
grep "is_healthy\|healthy session" ~/logs/sentinel-ai.log.2026-01-12

# 3. æŸ¥çœ‹è®¢é˜…è€…æ·»åŠ 
grep "Adding subscriber\|history chunks" ~/logs/sentinel-ai.log.2026-01-12
```

**å¯èƒ½åŸå› **ï¼š
- åº”ç”¨æ²¡æœ‰é‡å¯
- ä¼šè¯è¢«åˆ¤æ–­ä¸ºä¸å¥åº·å¹¶è¢«æ¸…ç†
- è®¢é˜…è€…æ·»åŠ å¤±è´¥

### é—®é¢˜ B: ä»ç„¶æœ‰è½¬ä¹‰åºåˆ—

**æ£€æŸ¥**ï¼š
```bash
# ç¡®è®¤å‡½æ•°å·²ç¼–è¯‘
grep "strip_ansi_codes" /Users/a1024/code/ai/sentinel-ai/src-tauri/target/debug/deps/*.d
```

**å¯èƒ½åŸå› **ï¼š
- ç¼–è¯‘æ²¡æœ‰åŒ…å«æœ€æ–°ä»£ç 
- éœ€è¦ `cargo clean && cargo build`

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PTY ç»ˆç«¯æµ‹è¯•æŒ‡å—](./pty-terminal-testing-guide.md)
- [äº¤äº’å¼ç»ˆç«¯å·¥ä½œæµç¨‹](./interactive-terminal-workflow.md)
- [ç»ˆç«¯æ˜¾ç¤ºé—®é¢˜è¯Šæ–­](./terminal-display-issue-diagnosis.md)

---

## ğŸ‰ ä¸‹ä¸€æ­¥

é‡å¯åº”ç”¨åï¼š

1. **ç«‹å³æµ‹è¯•**ï¼š"æ‰§è¡Œä¸€ä¸‹ whoami"
2. **æ£€æŸ¥æ—¥å¿—**ï¼šç¡®è®¤ PTY æ¨¡å¼å¯åŠ¨
3. **éªŒè¯ç»“æœ**ï¼šå·¦ä¾§æ— è½¬ä¹‰åºåˆ—ï¼Œå³ä¾§æ˜¾ç¤ºå®Œæ•´è¾“å‡º
4. **ç»§ç»­æµ‹è¯•**ï¼špingã€lsã€pwd ç­‰å‘½ä»¤

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ å°†çœ‹åˆ°ä¸€ä¸ª**å…¨åŠŸèƒ½çš„ PTY ç»ˆç«¯**ï¼Œæ”¯æŒï¼š
- âœ… çœŸæ­£çš„ TTY
- âœ… å®Œæ•´çš„ ANSI é¢œè‰²
- âœ… vim/nano ç¼–è¾‘å™¨
- âœ… ä¼šè¯æŒä¹…åŒ–
- âœ… å†å²è¾“å‡ºå›æ”¾
- âœ… æ—  Broken Pipe é”™è¯¯

ç¥æµ‹è¯•é¡ºåˆ©ï¼ğŸš€
