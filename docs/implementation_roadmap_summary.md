# AI驱动被动扫描自动化 - 实施路线图总结

## 🎯 项目目标

实现AI助手自动化安全测试能力：用户说"测试 XXX 网站的安全风险"，AI助手自动完成：
1. ✅ 启动被动扫描代理
2. 🔄 打开浏览器并配置代理
3. 🔄 访问目标网站并交互测试
4. 🔄 根据网站特征生成检测插件
5. 🔄 动态加载插件到扫描引擎
6. ✅ 实时显示检测过程和结果

---

## ✅ 当前状态评估

### 已完成的基础设施 (90%)

#### 1. 被动扫描系统 ✅ (100%)
- **Phase 1-6 全部完成**
- Hudsucker HTTP/HTTPS MITM代理
- Deno Core插件引擎
- SQLite数据库持久化
- Tauri事件系统实时推送
- 3个内置插件（SQL注入、XSS、敏感信息）

**评估**: 完全可用，无需修改

#### 2. AI助手系统 ✅ (95%)
- ReAct/Plan-Execute/ReWoo/LLM-Compiler多架构
- 统一工具管理器
- MCP协议集成
- 对话管理和上下文保持

**评估**: 完全可用，需增加浏览器自动化工具

#### 3. 前端UI ✅ (95%)
- PassiveScanControl（代理控制）
- VulnerabilityDashboard（漏洞看板）
- AIChat（AI对话）
- 实时事件监听

**评估**: 完全可用，需增强进度展示

### 缺失的关键模块 (10%)

#### 1. 浏览器自动化 ❌
**状态**: 未实现  
**影响**: 核心功能  
**优先级**: P0 (最高)

#### 2. AI插件生成 ❌
**状态**: 未实现  
**影响**: 高级功能  
**优先级**: P1 (高)

#### 3. 网站结构分析 ❌
**状态**: 未实现  
**影响**: 辅助功能  
**优先级**: P2 (中)

---

## 🚀 实施方案

### 方案A: MVP快速验证 (推荐首选)

**时间**: 1周（5个工作日）  
**成本**: 40小时  
**风险**: 低

#### 实施内容

**Day 1-2: 被动扫描MCP工具**
- [x] 包装现有Tauri命令为MCP工具
  - `passive_scan.start(config)` 
  - `passive_scan.stop()`
  - `passive_scan.get_findings(filters)`
- [x] 注册到统一工具管理器
- [ ] AI助手测试调用

**Day 3-4: 手动浏览器指引**
- [ ] AI生成代理配置指南（文本）
- [ ] 检测浏览器连接状态
- [ ] 提示用户完成配置

**Day 5-6: 模板化插件生成**
- [ ] 创建5-10个插件模板库
  - SQL注入检测模板
  - XSS检测模板
  - 越权检测模板
  - 信息泄露检测模板
- [ ] LLM根据用户需求选择模板
- [ ] 填充参数（目标参数名、规则等）
- [ ] 保存到数据库并加载

**Day 7: 实时UI增强**
- [ ] AIChat中显示测试进度卡片
- [ ] 实时更新漏洞流
- [ ] 集成测试

#### 验收标准
- ✅ 用户对AI说："测试 example.com 的SQL注入和XSS"
- ✅ AI自动启动被动扫描
- ✅ AI提示配置浏览器代理
- ✅ AI根据需求生成2个插件
- ✅ 实时显示发现的漏洞

#### 用户体验

```
用户: 打开被动扫描，测试 https://zeus.imgo.tv/ 是否存在SQL注入和XSS漏洞

AI助手:
好的，我将为您启动被动扫描测试。

[执行工具: passive_scan.start]
✅ 被动扫描已启动，监听端口: 4201

[生成插件: zeus_sqli_detector]
✅ 已生成SQL注入检测插件

[生成插件: zeus_xss_detector]  
✅ 已生成XSS检测插件

[插件已加载到扫描引擎]

📋 接下来请按照以下步骤配置浏览器:

1. 打开浏览器代理设置
2. HTTP代理: 127.0.0.1
3. 端口: 4201
4. 保存并访问目标网站

我会实时监控并报告发现的漏洞。

[等待浏览器连接...]

✅ 检测到浏览器连接

🔍 开始监控 https://zeus.imgo.tv/ ...

⚠️ 发现漏洞: SQL注入 (搜索参数 'q') - CRITICAL
⚠️ 发现漏洞: 存储型XSS (评论功能) - HIGH

当前统计:
- 请求数: 23
- 发现漏洞: 2个

是否需要查看详细报告？
```

---

### 方案B: 完整自动化实现

**时间**: 3周（15个工作日）  
**成本**: 120小时  
**风险**: 中

#### Phase 1: MVP (Week 1)
同方案A

#### Phase 2: 浏览器自动化 (Week 2)

**Day 1-2: 集成Fantoccini**
- [ ] 添加依赖和初始化
- [ ] 封装WebDriver管理器
- [ ] 实现基础操作（launch/navigate/click/fill）

**Day 3-4: 实现MCP工具**
- [ ] browser.launch(proxy_port, headless)
- [ ] browser.navigate(url)
- [ ] browser.click(selector)
- [ ] browser.fill(selector, value)
- [ ] browser.screenshot()
- [ ] browser.close()

**Day 5-6: 智能交互测试**
- [ ] 自动识别表单
- [ ] 自动填充测试数据
- [ ] 模拟用户点击流
- [ ] 错误处理和重试

**Day 7: 集成测试**
- [ ] 与被动扫描联调
- [ ] 端到端测试

#### Phase 3: 高级AI插件生成 (Week 3)

**Day 1-2: 网站分析器**
- [ ] 从代理日志提取API端点
- [ ] 参数模式识别
- [ ] 技术栈检测

**Day 3-4: AI代码生成**
- [ ] 设计生成Prompt
- [ ] 实现代码验证
- [ ] 插件测试框架

**Day 5-6: 质量优化**
- [ ] 人工审核UI
- [ ] 插件评分系统
- [ ] Few-shot学习

**Day 7: 完整工作流**
- [ ] 组合所有工具
- [ ] 端到端测试
- [ ] 性能优化

#### 验收标准
- ✅ 用户对AI说："测试 example.com 的所有安全风险"
- ✅ AI自动启动代理和浏览器
- ✅ AI自动访问网站并交互
- ✅ AI根据网站生成5-10个插件
- ✅ 实时显示测试进度和结果
- ✅ 自动生成HTML报告

---

## 📊 技术选型

### 浏览器自动化: Fantoccini ⭐⭐⭐⭐⭐

**理由**:
- ✅ Rust原生，无外部依赖
- ✅ 兼容Chrome/Firefox/Edge
- ✅ 异步支持，性能好
- ✅ 社区活跃，文档完善

**替代方案**: headless_chrome, thirtyfour

### 插件生成: 模板填充 + LLM

**理由**:
- ✅ 快速实现，风险低
- ✅ 代码质量可控
- ✅ 易于维护和扩展

**进阶方案**: 完整AI代码生成（Week 3）

### UI交互: 进度卡片 + 事件监听

**理由**:
- ✅ 用户体验好
- ✅ 实时性强
- ✅ 复用现有事件系统

---

## 🎯 里程碑

### Milestone 1: MVP可用 (Week 1)
- [ ] AI可自动启动被动扫描
- [ ] AI可生成基础插件
- [ ] 实时显示漏洞

**交付物**:
- MCP工具: passive_scan.start/stop/get_findings
- 插件模板库 (5个)
- 插件生成工具
- 实时进度UI组件

### Milestone 2: 浏览器自动化 (Week 2)
- [ ] AI可自动打开浏览器
- [ ] 浏览器自动配置代理
- [ ] 智能交互测试

**交付物**:
- Fantoccini集成模块
- MCP工具: browser.*
- 自动化测试流程

### Milestone 3: 高级AI生成 (Week 3)
- [ ] 网站结构自动分析
- [ ] AI生成高质量插件
- [ ] 完整自动化工作流

**交付物**:
- 网站分析器
- AI代码生成器
- 人工审核UI
- 完整测试报告

---

## 🔒 风险管理

### 技术风险

| 风险 | 等级 | 影响 | 缓解措施 |
|------|------|------|---------|
| 浏览器自动化不稳定 | 中 | 测试失败率高 | 使用成熟的Selenium协议 |
| AI生成代码质量低 | 高 | 误报/漏报 | 模板化生成 + 人工审核 |
| 性能问题 | 低 | 测试速度慢 | 异步执行 + 资源限制 |
| 兼容性问题 | 低 | 部分网站失败 | 多浏览器支持 + 错误处理 |

### 安全风险

| 风险 | 等级 | 影响 | 缓解措施 |
|------|------|------|---------|
| 恶意插件代码 | 高 | 系统被破坏 | Deno沙箱 + 代码审核 |
| 数据泄露 | 中 | 隐私问题 | 加密存储 + 用户授权 |
| 浏览器访问恶意站点 | 中 | 安全威胁 | URL白名单 + 用户确认 |

---

## 📈 后续规划

### 短期优化 (1-2个月)
- [ ] 增加内置插件模板（20+）
- [ ] 支持认证流程自动化
- [ ] 优化插件生成质量
- [ ] 增加更多浏览器操作

### 中期扩展 (3-6个月)
- [ ] 集成主动扫描工具（Nuclei）
- [ ] 分布式测试支持
- [ ] AI驱动的漏洞验证
- [ ] PoC自动生成

### 长期愿景 (6-12个月)
- [ ] 移动应用测试（Android/iOS）
- [ ] 漏洞数据库集成（CVE/NVD）
- [ ] 社区插件市场
- [ ] AI驱动的修复建议

---

## 💡 推荐决策

### 立即开始: 方案A (MVP)

**理由**:
1. ✅ 快速验证核心流程（1周）
2. ✅ 最小风险，最大收益
3. ✅ 90%功能已实现，仅需10%工作量
4. ✅ 可立即展示给用户

**行动计划**:
1. 本周完成MVP开发
2. 下周进行用户测试和反馈
3. 根据反馈决定是否继续方案B

### 条件触发: 方案B (完整版)

**触发条件**:
- MVP用户反馈良好
- 手动配置浏览器体验不佳
- 用户需求强烈

**时间规划**:
- Week 2-3: 浏览器自动化
- Week 4: AI插件生成优化
- Week 5: 测试和优化

---

## 📝 下一步行动

### 立即可做（无需开发）
1. ✅ 查看已实现的被动扫描功能
2. ✅ 测试现有插件（sqli.ts, xss.ts, sensitive_info.ts）
3. ✅ 体验实时漏洞发现流

### 本周开发（MVP）
1. [ ] Day 1: 封装被动扫描MCP工具
2. [ ] Day 2: 创建插件模板库
3. [ ] Day 3: 实现模板化插件生成
4. [ ] Day 4: 实时UI增强
5. [ ] Day 5: 集成测试和文档

### 下周决策
- [ ] 评估MVP效果
- [ ] 收集用户反馈
- [ ] 决定是否启动方案B

---

## 🎉 总结

### 核心结论

✅ **项目完全可行，当前架构已支持90%功能**

关键优势:
1. 被动扫描系统完善（Phase 1-6已完成）
2. AI助手系统成熟（多架构、工具调用）
3. 实时事件系统完备（Tauri Events）
4. 仅需补充10%功能即可实现MVP

### 推荐路径

**第1周**: MVP实现（模板化插件生成 + 手动浏览器）
- 交付时间: 5个工作日
- 工作量: 40小时
- 风险: 低

**第2-3周**: 完整自动化（浏览器自动化 + AI代码生成）
- 交付时间: 10个工作日
- 工作量: 80小时
- 风险: 中

### 预期效果

**MVP版本**:
```
用户: 测试 zeus.imgo.tv 的SQL注入
AI: 
  ✅ 启动被动扫描 (端口4201)
  ✅ 生成SQL注入检测插件
  📋 请配置浏览器代理
  🔍 开始监控...
  ⚠️ 发现漏洞: SQL注入 (参数 'id')
```

**完整版本**:
```
用户: 测试 zeus.imgo.tv 的所有安全风险
AI:
  ✅ 启动被动扫描
  ✅ 启动Chrome浏览器（代理已配置）
  ✅ 访问首页
  ✅ 分析网站结构（发现15个API端点）
  ✅ 生成5个检测插件
  🔍 自动化测试中...
  ⚠️ 发现8个漏洞（2 Critical, 3 High, 3 Medium）
  📄 生成HTML报告
```

---

**状态**: ✅ 计划完成，等待审批  
**创建日期**: 2025-11-12  
**预计开始**: 待定  
**负责人**: 待分配

